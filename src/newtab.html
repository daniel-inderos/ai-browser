<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Tab</title>
    <link rel="stylesheet" href="index.css">
    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--color-background);
            color: var(--color-text-primary);
            font-size: 14px;
        }

        .container {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 1rem;
            transition: padding var(--transition-normal);
        }

        .main-wrapper {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: max-width var(--transition-normal), transform var(--transition-normal);
        }

        .logo { font-size: 1.5em; font-weight: 300; margin-bottom: 2rem; color: var(--color-text-primary); transition: opacity var(--transition-normal), transform var(--transition-normal), margin var(--transition-normal), height var(--transition-normal); }

        /* --- MODE TOGGLE --- */
        .mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
        }
        .mode-btn { padding: 0.5rem 1rem; border: 1px solid var(--color-border); border-radius: var(--radius-full); background: transparent; color: var(--color-text-tertiary); cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; }
        .mode-btn.active { background: var(--color-primary); color: var(--color-text-inverse); border-color: var(--color-primary); }

        /* --- SEARCH WRAPPER --- */
        #searchWrapper { width: 100%; }
        #searchForm { width: 100%; position: relative; }
        #searchInput { width: 100%; padding: 1rem 1.5rem; font-size: 1.125rem; border-radius: var(--radius-full); border: 1px solid var(--color-border); background: var(--color-surface-elevated); color: var(--color-text-primary); outline: none; box-sizing: border-box; }
        #searchInput:focus { background: var(--color-surface); border-color: var(--color-border-focus); box-shadow: var(--shadow-focus), var(--shadow-md); }

        /* --- ASK WRAPPER (CHAT UI) --- */
        #askWrapper { width: 100%; max-width: 860px; height: 72vh; display: flex; flex-direction: column; gap: 0.75rem; transition: max-width var(--transition-normal), height var(--transition-normal), transform var(--transition-normal); }

        /* Header */
        .ask-header { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 var(--spacing-1); color: var(--color-text-tertiary); font-size: var(--font-size-xs); }
        .ask-badge { display: inline-flex; align-items: center; gap: .4rem; padding: .25rem .6rem; border: 1px solid var(--color-border); border-radius: var(--radius-full); color: var(--color-text-secondary); }
        .ask-actions { display: inline-flex; align-items: center; gap: .5rem; }
        .icon-btn { display: inline-flex; align-items:center; justify-content:center; width: 28px; height: 28px; border: 1px solid var(--color-border); border-radius: var(--radius-full); background: var(--color-surface-elevated); color: var(--color-text-secondary); cursor: pointer; transition: transform .1s ease, background var(--transition-fast), border var(--transition-fast); }
        .icon-btn:hover { background: var(--color-surface-hover); transform: translateY(-1px); }

        /* Chat surface */
        .chat-surface { position: relative; flex: 1; display: flex; flex-direction: column; gap: var(--spacing-3); padding: var(--spacing-4); border: 1px solid var(--color-border); border-radius: var(--radius-lg); background: linear-gradient(180deg, var(--color-surface), var(--color-background)); box-shadow: var(--shadow-md); overflow: hidden; }
        .chat-history { flex: 1; overflow-y: auto; padding-right: var(--spacing-2); scroll-behavior: smooth; }
        .chat-history::-webkit-scrollbar { width: 10px; }
        .chat-history::-webkit-scrollbar-thumb { background: var(--color-border); border-radius: 10px; }
        .chat-empty { height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; color: var(--color-text-secondary); }
        .empty-inner { max-width: 520px; display: flex; flex-direction: column; gap: var(--spacing-4); }
        .empty-title { font-size: var(--font-size-xl); color: var(--color-text-primary); font-weight: var(--font-weight-semibold); }
        .empty-prompts { display: flex; flex-wrap: wrap; gap: var(--spacing-2); justify-content: center; }
        .prompt-chip { padding: .45rem .7rem; border: 1px solid var(--color-border); border-radius: var(--radius-full); background: var(--color-surface-elevated); color: var(--color-text-secondary); cursor: pointer; }
        .prompt-chip:hover { background: var(--color-surface-hover); }
        .empty-hint { font-size: var(--font-size-xs); color: var(--color-text-tertiary); }

        /* Message bubbles */
        .chat-msg { display: grid; grid-template-columns: 36px 1fr; gap: var(--spacing-3); margin-bottom: var(--spacing-3); }
        .avatar { width: 36px; height: 36px; border-radius: var(--radius-full); display: flex; align-items:center; justify-content:center; border: 1px solid var(--color-border); background: var(--color-surface-elevated); color: var(--color-text-secondary); font-weight: var(--font-weight-semibold); }
        .bubble { padding: var(--spacing-3); border: 1px solid var(--color-border); border-radius: var(--radius-lg); background: var(--color-surface); box-shadow: var(--shadow-sm); }
        .user-msg .bubble { background: var(--color-surface-elevated); }
        .assistant-msg .bubble { background: var(--color-surface); }
        .chat-label { display:none; }
        .chat-content { line-height: var(--line-height-relaxed); font-size: var(--font-size-sm); }
        .chat-content pre { background: var(--color-background-secondary); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-3); overflow-x:auto; font-family: var(--font-family-mono); font-size: 12px; position: relative; }
        .copy-code { position:absolute; top:8px; right:8px; font-size: 11px; padding: 4px 8px; border-radius: var(--radius-full); border: 1px solid var(--color-border); background: var(--color-surface-elevated); color: var(--color-text-secondary); cursor: pointer; }
        .copy-code:hover { background: var(--color-surface-hover); }
        .streaming-dot { display:inline-block; width:6px; height:6px; border-radius:50%; background: var(--color-text-secondary); margin-left: 6px; animation: pulse 1.2s infinite; vertical-align: middle; }

        /* Input */
        .chat-input-area { display: flex; flex-direction: column; gap: var(--spacing-2); }
        .context-pills-container { display: flex; gap: var(--spacing-2); margin-bottom: 0; overflow-x: auto; padding-bottom: var(--spacing-1); }
        .context-pill { display: flex; align-items: center; gap: var(--spacing-2); background: var(--color-surface-hover); border-radius: var(--radius-full); padding: var(--spacing-1) var(--spacing-2); font-size: 0.75rem; }
        .context-pill-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 220px; }
        .context-pill-remove { background: none; border: none; color: var(--color-text-tertiary); cursor: pointer; }
        .chat-input-container { display: flex; align-items: flex-end; gap: var(--spacing-2); }
        .chat-input-wrapper { flex: 1; position: relative; }
        textarea.chat-input { width: 100%; min-height: 44px; max-height: 160px; resize: none; padding: var(--spacing-3) calc(var(--spacing-4) + 2px); background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-lg); font-family: var(--font-family-primary); font-size: var(--font-size-sm); color: var(--color-text-primary); box-shadow: var(--shadow-sm); }
        textarea.chat-input:focus { background: var(--color-surface); border-color: var(--color-border-focus); box-shadow: var(--shadow-focus), var(--shadow-md); }
        .send-area { display:flex; align-items:center; gap:.5rem; }
        .chat-send-btn { background: var(--color-primary); color: var(--color-text-inverse); border: none; border-radius: var(--radius-full); width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow: var(--shadow-md); }
        .chat-send-btn:disabled { opacity:.5; cursor:not-allowed; box-shadow:none; }
        .chat-stop-btn { display:none; background: var(--color-surface-elevated); color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: var(--radius-full); height: 36px; padding: 0 .75rem; cursor: pointer; }
        .tab-suggestions { display: none; position: absolute; bottom: calc(100% + var(--spacing-1)); left: 0; right: 0; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-md); max-height: 220px; overflow-y: auto; z-index: 101; box-shadow: var(--shadow-lg); }
        .suggestion-item { padding: var(--spacing-2) var(--spacing-3); cursor: pointer; }
        .suggestion-item:hover { background: var(--color-surface-hover); }
        .suggestion-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .suggestion-url { font-size: 0.8rem; color: var(--color-text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Expanded Ask mode (full page) */
        body.is-ask-expanded .container {
            padding: var(--spacing-6);
        }
        body.is-ask-expanded .main-wrapper {
            max-width: 1200px;
            align-items: stretch;
        }
        @media (max-width: 1280px) {
            body.is-ask-expanded .main-wrapper { max-width: none; }
        }
        body.is-ask-expanded .logo {
            opacity: 0;
            transform: translateY(-6px);
            margin: 0;
            height: 0;
            pointer-events: none;
        }
        body.is-ask-expanded .mode-toggle {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 100;
            background: var(--color-surface-elevated);
            padding: 4px;
            border-radius: var(--radius-full);
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-md);
        }
        body.is-ask-expanded #askWrapper {
            max-width: none;
            height: calc(100vh - 2 * var(--spacing-6));
            transform: translateZ(0);
        }
        body.is-ask-expanded .chat-surface {
            border-radius: var(--radius-xl);
        }
        @media (prefers-reduced-motion: reduce) {
            .container, .main-wrapper, #askWrapper, .mode-toggle, .logo { transition: none !important; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-wrapper" id="mainWrapper">
            <div class="logo">AI Browser</div>
            <div class="mode-toggle" id="modeToggle">
                <button id="modeSearch" class="mode-btn active">Search</button>
                <button id="modeAsk" class="mode-btn">Ask</button>
            </div>

            <button id="enableGroupingBtn" class="mode-btn">Enable AI Tab Groups</button>

            <!-- Search Mode UI -->
            <div id="searchWrapper">
                <form id="searchForm" autocomplete="off">
                    <input id="searchInput" type="text" placeholder="Search or enter website" autofocus />
                </form>
            </div>

            <!-- Ask Mode UI (hidden by default) -->
            <div id="askWrapper" style="display:none;">
                <div class="ask-header">
                    <div class="ask-badge" title="Ask Assistant">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                        Ask
                    </div>
                    <div class="ask-actions">
                        <button class="icon-btn" id="focusUrlBtn" title="Focus address (⌘L)" aria-label="Focus address">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
                        </button>
                        <button class="icon-btn" id="clearChatTopBtn" title="Clear chat" aria-label="Clear chat">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6v12a2 2 0 002 2h4a2 2 0 002-2V6"/><line x1="10" y1="11" x2="14" y2="11"/><line x1="10" y1="15" x2="14" y2="15"/></svg>
                        </button>
                    </div>
                </div>
                <div class="chat-surface">
                    <div class="chat-history" id="chatHistory" aria-live="polite"></div>
                    <div class="chat-input-area">
                        <div id="contextPillsContainer" class="context-pills-container"></div>
                        <form class="chat-input-container" id="chatInputForm" autocomplete="off">
                            <div class="chat-input-wrapper">
                                <textarea id="chatInput" class="chat-input" placeholder="Ask a question..." rows="1"></textarea>
                                <div id="tabSuggestions" class="tab-suggestions"></div>
                            </div>
                            <div class="send-area">
                                <button type="button" class="chat-stop-btn" id="chatStopBtn">Stop</button>
                                <button type="submit" class="chat-send-btn" id="chatSendBtn" aria-label="Send message" disabled>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></svg>
                                </button>
                            </div>
                        </form>
                        <div class="empty-hint">Tip: type @ to reference any open tab</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class NewTabManager {
            constructor() {
                this.elements = {
                    modeSearch: document.getElementById('modeSearch'),
                    modeAsk: document.getElementById('modeAsk'),
                    searchWrapper: document.getElementById('searchWrapper'),
                    askWrapper: document.getElementById('askWrapper'),
                    searchInput: document.getElementById('searchInput'),
                    searchForm: document.getElementById('searchForm'),
                    enableGroupingBtn: document.getElementById('enableGroupingBtn'),
                };
                this.mode = 'search';
                this.askManager = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.elements.modeSearch.addEventListener('click', () => this.switchMode('search'));
                this.elements.modeAsk.addEventListener('click', () => this.switchMode('ask'));
                this.elements.searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSearch();
                });
                this.elements.enableGroupingBtn.addEventListener('click', () => {
                    if (window.electronAPI && window.electronAPI.sendToHost) {
                        window.electronAPI.sendToHost('enable-grouping', {});
                    }
                    this.elements.enableGroupingBtn.disabled = true;
                });

                // Forward common browser shortcuts to host so they work immediately
                window.addEventListener('keydown', (e) => {
                    if (!(e.metaKey || e.ctrlKey)) return;
                    const k = e.key.toLowerCase();
                    switch (k) {
                        case 't': // New tab
                            e.preventDefault();
                            this.sendShortcut('new-tab');
                            break;
                        case 'w': // Close tab
                            e.preventDefault();
                            this.sendShortcut('close-tab');
                            break;
                        case 'r': // Refresh
                            e.preventDefault();
                            this.sendShortcut('refresh-page');
                            break;
                        case 'l': // Focus URL bar in host
                            e.preventDefault();
                            this.sendShortcut('focus-url');
                            break;
                        case 'e': // Toggle chat sidebar in host
                            e.preventDefault();
                            this.sendShortcut('toggle-chat');
                            break;
                        default:
                            break;
                    }
                });
            }

            sendShortcut(command) {
                if (window.electronAPI && window.electronAPI.sendToHost) {
                    window.electronAPI.sendToHost('shortcut', { command });
                }
            }

            switchMode(newMode) {
                if (this.mode === newMode) return;
                this.mode = newMode;

                const isSearch = newMode === 'search';
                this.elements.modeSearch.classList.toggle('active', isSearch);
                this.elements.modeAsk.classList.toggle('active', !isSearch);
                this.elements.searchWrapper.style.display = isSearch ? 'block' : 'none';
                this.elements.askWrapper.style.display = isSearch ? 'none' : 'flex';

                if (isSearch) {
                    document.body.classList.remove('is-ask-expanded');
                    this.elements.searchInput.focus();
                } else {
                    if (!this.askManager) {
                        this.askManager = new AskManager();
                    }
                    // Expand to full-page Ask with a smooth animation
                    // Use rAF to ensure class toggle animates cleanly
                    requestAnimationFrame(() => document.body.classList.add('is-ask-expanded'));
                    this.askManager.elements.chatInput.focus();
                }
            }

            handleSearch() {
                const value = this.elements.searchInput.value.trim();
                if (!value) return;
                let target = value;
                if (!/^https?:\/\//i.test(value)) {
                    target = value.includes('.') && !value.includes(' ')
                        ? 'https://' + value
                        : 'https://www.google.com/search?q=' + encodeURIComponent(value);
                }
                window.location.href = target;
            }
        }

        class AskManager {
            constructor() {
                this.elements = {
                    chatHistory: document.getElementById('chatHistory'),
                    contextPillsContainer: document.getElementById('contextPillsContainer'),
                    chatInputForm: document.getElementById('chatInputForm'),
                    chatInput: document.getElementById('chatInput'),
                    tabSuggestions: document.getElementById('tabSuggestions'),
                    chatClearBtn: document.getElementById('clearChatTopBtn'),
                    chatSendBtn: document.getElementById('chatSendBtn'),
                    chatStopBtn: document.getElementById('chatStopBtn'),
                    focusUrlBtn: document.getElementById('focusUrlBtn'),
                };
                this.session = [];
                this.referencedTabs = new Set();
                this.allTabs = [];
                this.currentStream = null;
                this.marked = window.marked;
                this.setupEventListeners();
                this.renderEmptyState();
            }

            setupEventListeners() {
                this.elements.chatInputForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleChatSend();
                });
                this.elements.chatInput.addEventListener('input', () => this.onEditorInput());
                this.elements.chatInput.addEventListener('keydown', (e) => this.onEditorKeydown(e));
                this.elements.tabSuggestions.addEventListener('click', (e) => this.handleSuggestionClick(e));
                this.elements.chatClearBtn.addEventListener('click', () => this.clearChat());
                this.elements.chatStopBtn.addEventListener('click', () => this.stopStreaming());
                this.elements.focusUrlBtn.addEventListener('click', () => this.sendShortcut('focus-url'));
                window.addEventListener('message', (e) => this.handleHostMessage(e));
                if (window.electronAPI && window.electronAPI.onFromHost) {
                    window.electronAPI.onFromHost((data) => this.handleHostMessage({ data }));
                }
            }
            
            handleHostMessage({ data }) {
                if (!data || !data.type) return;
                switch (data.type) {
                    case 'tabs-response':
                        this.allTabs = data.tabs || [];
                        this.renderTabSuggestions(this.elements.chatInput.value);
                        break;
                    case 'chat-stream-response':
                        this.handleStreamResponse(data);
                        break;
                }
            }

            handleChatSend() {
                const content = this.elements.chatInput.value.trim();
                if (!content) return;
                this.elements.chatInput.value = '';
                this.autoResizeEditor();
                this.elements.chatSendBtn.disabled = true;

                this.session.push({ role: 'user', content });
                const assistantMsg = { role: 'assistant', content: '' };
                this.session.push(assistantMsg);
                this.renderChatHistory();

                const reqId = Date.now().toString();
                this.currentStream = { id: reqId, assistantIndex: this.session.length - 1 };
                this.toggleStreamingUI(true);

                const chatData = {
                    reqId,
                    session: this.session.slice(0, -1),
                    referencedTabIds: [...this.referencedTabs]
                };
                console.log('NewTab: sendToHost new-tab-chat-send:', chatData);
                if (window.electronAPI && window.electronAPI.sendToHost) {
                    window.electronAPI.sendToHost('new-tab-chat-send', chatData);
                }
            }

            handleStreamResponse(data) {
                if (!this.currentStream || data.id !== this.currentStream.id) return;
                
                const assistantMsg = this.session[this.currentStream.assistantIndex];
                if (data.token) {
                    assistantMsg.content += data.token;
                    this.updateAssistantMessage(assistantMsg.content, false);
                }
                if (data.done || data.error) {
                    if(data.error) assistantMsg.content = `Error: ${data.error}`;
                    this.updateAssistantMessage(assistantMsg.content, true);
                    this.currentStream = null;
                    this.toggleStreamingUI(false);
                }
            }
            
            updateAssistantMessage(content, isFinal) {
                const msgEls = this.elements.chatHistory.querySelectorAll('.assistant-msg');
                const lastMsgEl = msgEls[msgEls.length - 1];
                if (lastMsgEl) {
                    const contentEl = lastMsgEl.querySelector('.chat-content');
                    contentEl.innerHTML = isFinal ? this.marked.parse(content) : content.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
                    this.decorateCodeBlocks(lastMsgEl);
                    if (!isFinal) {
                        this.ensureStreamingDot(lastMsgEl);
                    } else {
                        this.removeStreamingDot(lastMsgEl);
                    }
                    this.elements.chatHistory.scrollTop = this.elements.chatHistory.scrollHeight;
                }
            }

            renderChatHistory() {
                if (this.session.length === 0) {
                    this.renderEmptyState();
                    return;
                }
                this.elements.chatHistory.innerHTML = this.session.map(msg => {
                    const safe = (s) => (s || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
                    const content = msg.role === 'assistant' ? this.marked.parse(msg.content || '') : safe(msg.content || '');
                    const avatar = msg.role === 'user' ? 'You' : 'AI';
                    return `
                        <div class="chat-msg ${msg.role}-msg">
                            <div class="avatar">${avatar.substring(0,2)}</div>
                            <div class="bubble">
                                <div class="chat-content">${content}</div>
                            </div>
                        </div>`;
                }).join('');
                // Add copy buttons to any code blocks
                this.elements.chatHistory.querySelectorAll('.assistant-msg').forEach(wrapper => this.decorateCodeBlocks(wrapper));
                this.elements.chatHistory.scrollTop = this.elements.chatHistory.scrollHeight;
            }

            handleChatInput() {
                const value = this.elements.chatInput.value;
                const atIndex = value.lastIndexOf('@');
                if (atIndex > -1 && (atIndex === 0 || /\s/.test(value[atIndex - 1]))) {
                    console.log('NewTab: sendToHost request-tabs');
                    if (window.electronAPI && window.electronAPI.sendToHost) {
                        window.electronAPI.sendToHost('request-tabs', {});
                    }
                    this.renderTabSuggestions(value);
                } else {
                    this.hideTabSuggestions();
                }
            }

            renderTabSuggestions(value) {
                const query = value.substring(value.lastIndexOf('@') + 1).toLowerCase();
                const availableTabs = this.allTabs.filter(t => !this.referencedTabs.has(t.id));
                const filtered = query
                    ? availableTabs.filter(t => t.title.toLowerCase().includes(query) || t.url.toLowerCase().includes(query))
                    : availableTabs;

                if (filtered.length > 0) {
                    this.elements.tabSuggestions.innerHTML = filtered.map(tab => `
                        <div class="suggestion-item" data-tab-id="${tab.id}" data-tab-title="${this.escapeHtml(tab.title)}">
                            <div class="suggestion-title">${this.escapeHtml(tab.title)}</div>
                            <div class="suggestion-url">${this.escapeHtml(tab.url)}</div>
                        </div>`).join('');
                    this.elements.tabSuggestions.style.display = 'block';
                } else {
                    this.hideTabSuggestions();
                }
            }
            
            handleSuggestionClick(e) {
                const item = e.target.closest('.suggestion-item');
                if (!item) return;

                const tabId = item.getAttribute('data-tab-id');
                const tabTitle = item.getAttribute('data-tab-title');
                this.referencedTabs.add(tabId);
                this.renderContextPills();
                this.updatePlaceholder();
                
                const atIndex = this.elements.chatInput.value.lastIndexOf('@');
                this.elements.chatInput.value = this.elements.chatInput.value.substring(0, atIndex);
                this.hideTabSuggestions();
                this.elements.chatInput.focus();
            }

            renderContextPills() {
                this.elements.contextPillsContainer.innerHTML = '';
                this.referencedTabs.forEach(tabId => {
                    const tab = this.allTabs.find(t => t.id === tabId);
                    const pill = document.createElement('div');
                    pill.className = 'context-pill';
                    pill.innerHTML = `
                        <span class="context-pill-title" title="${this.escapeHtml(tab ? tab.title : tabId)}">${this.escapeHtml(tab ? tab.title : tabId)}</span>
                        <button class="context-pill-remove" data-tab-id="${tabId}">&times;</button>`;
                    pill.querySelector('.context-pill-remove').addEventListener('click', () => {
                        this.referencedTabs.delete(tabId);
                        this.renderContextPills();
                        this.updatePlaceholder();
                    });
                    this.elements.contextPillsContainer.appendChild(pill);
                });
            }

            clearChat() {
                this.session = [];
                this.referencedTabs.clear();
                this.renderChatHistory();
                this.renderContextPills();
                this.updatePlaceholder();
            }

            updatePlaceholder() {
                const hasContext = this.referencedTabs.size > 0;
                this.elements.chatInput.placeholder = hasContext ? 'Ask a question about the page(s)...' : 'Ask a question...';
            }

            hideTabSuggestions() { this.elements.tabSuggestions.style.display = 'none'; }
            escapeHtml(str) { return (str || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }

            // --- UI Enhancements ---
            renderEmptyState() {
                this.elements.chatHistory.innerHTML = `
                    <div class="chat-empty">
                        <div class="empty-inner">
                            <div class="empty-title">Ask anything</div>
                            <div class="empty-hint">Get answers, summarize pages, and reference tabs with @</div>
                            <div class="empty-prompts" id="quickPrompts"></div>
                        </div>
                    </div>`;
                const prompts = [
                    'Tell me a fun fact',
                    'What’s a good joke?',
                    'Teach me a random word',
                    'Give me a productivity tip',
                    'What happened on this day in history?'
                ];
                const container = this.elements.chatHistory.querySelector('#quickPrompts');
                prompts.forEach(p => {
                    const chip = document.createElement('button');
                    chip.type = 'button';
                    chip.className = 'prompt-chip';
                    chip.textContent = p;
                    chip.addEventListener('click', () => {
                        this.elements.chatInput.value = p;
                        this.autoResizeEditor();
                        this.elements.chatSendBtn.disabled = false;
                        this.elements.chatInput.focus();
                    });
                    container.appendChild(chip);
                });
            }

            onEditorInput() {
                this.autoResizeEditor();
                this.elements.chatSendBtn.disabled = this.elements.chatInput.value.trim().length === 0;
                this.handleChatInput();
            }

            onEditorKeydown(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.handleChatSend();
                }
            }

            autoResizeEditor() {
                const ta = this.elements.chatInput;
                ta.style.height = 'auto';
                ta.style.height = Math.min(ta.scrollHeight, 160) + 'px';
            }

            toggleStreamingUI(isStreaming) {
                this.elements.chatStopBtn.style.display = isStreaming ? 'inline-flex' : 'none';
            }

            ensureStreamingDot(wrapper) {
                if (!wrapper.querySelector('.streaming-dot')) {
                    const dot = document.createElement('span');
                    dot.className = 'streaming-dot';
                    const bubble = wrapper.querySelector('.bubble .chat-content');
                    if (bubble) bubble.appendChild(dot);
                }
            }

            removeStreamingDot(wrapper) {
                wrapper.querySelectorAll('.streaming-dot').forEach(el => el.remove());
            }

            stopStreaming() {
                // Best-effort: stop updating UI for current stream
                this.currentStream = null;
                this.toggleStreamingUI(false);
            }

            decorateCodeBlocks(wrapper) {
                wrapper.querySelectorAll('pre').forEach(pre => {
                    if (pre.querySelector('.copy-code')) return;
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'copy-code';
                    btn.textContent = 'Copy';
                    btn.addEventListener('click', async () => {
                        try {
                            const code = pre.innerText;
                            await navigator.clipboard.writeText(code);
                            btn.textContent = 'Copied';
                            setTimeout(() => btn.textContent = 'Copy', 1200);
                        } catch (e) {}
                    });
                    pre.appendChild(btn);
                });
            }

            sendShortcut(command) {
                if (window.electronAPI && window.electronAPI.sendToHost) {
                    window.electronAPI.sendToHost('shortcut', { command });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => new NewTabManager());
    </script>
</body>
</html> 
