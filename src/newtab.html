<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Tab</title>
    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #000;
            --input-bg: #fff;
            --input-border: #ccc;
            --input-focus-border: #333;
            --btn-active-color: #000;
            --btn-inactive-color: #888;
            --surface-elevated: #f2f2f2;
            --surface-hover: #e6e6e6;
            --surface-active: #d9d9d9;
            --text-tertiary: #777777;
            --radius-md: 0.5rem;
            --radius-full: 9999px;
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 0.75rem;
            --spacing-4: 1rem;
            --spacing-5: 1.25rem;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #000;
                --text-color: #fff;
                --input-bg: #1a1a1a;
                --input-border: #444;
                --input-focus-border: #fff;
                --btn-active-color: #fff;
                --btn-inactive-color: #888;
                --surface-elevated: #1a1a1a;
                --surface-hover: #333333;
                --surface-active: #4d4d4d;
                --text-tertiary: #a0a0a0;
            }
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 14px;
        }

        .container {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 1rem;
        }

        .main-wrapper {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 300;
            margin-bottom: 2rem;
            color: var(--text-color);
        }

        /* --- MODE TOGGLE --- */
        .mode-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .mode-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--input-border);
            border-radius: 9999px;
            background: transparent;
            color: var(--btn-inactive-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .mode-btn.active {
            background: var(--btn-active-color);
            color: var(--bg-color);
            border-color: var(--btn-active-color);
        }

        /* --- SEARCH WRAPPER --- */
        #searchWrapper { width: 100%; }
        #searchForm { width: 100%; position: relative; }
        #searchInput {
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.125rem;
            border-radius: 9999px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-color);
            outline: none;
            box-sizing: border-box;
        }

        /* --- ASK WRAPPER (CHAT UI) --- */
        #askWrapper {
            width: 100%;
            max-width: 700px;
            height: 70vh;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Chat history */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-2);
            border: 1px solid var(--input-border);
            border-radius: var(--radius-md);
            background: var(--input-bg);
        }
        .chat-msg {
            margin-bottom: var(--spacing-3);
            white-space: pre-wrap;
            line-height: 1.5;
        }
        .user-msg { text-align: right; }
        .chat-label { font-size: 0.8rem; font-weight: 600; margin-bottom: var(--spacing-1); }
        .chat-content { white-space: pre-wrap; word-wrap: break-word; }
        .chat-content p:not(:last-child) { margin-bottom: var(--spacing-3); }
        .chat-content ul, .chat-content ol { padding-left: var(--spacing-5); }
        .chat-content pre { background: var(--surface-elevated); padding: var(--spacing-3); border-radius: var(--radius-md); overflow-x: auto; }
        .chat-content code { font-family: monospace; background: var(--surface-elevated); padding: 2px 5px; border-radius: 0.25rem; }
        .chat-content pre code { background: none; padding: 0; }

        /* Input Area */
        .chat-input-area { padding-top: var(--spacing-2); border-top: 1px solid var(--input-border); }
        .context-pills-container { display: flex; gap: var(--spacing-2); margin-bottom: var(--spacing-2); overflow-x: auto; padding-bottom: var(--spacing-1); }
        .context-pill { display: flex; align-items: center; gap: var(--spacing-2); background: var(--surface-hover); border-radius: var(--radius-full); padding: var(--spacing-1) var(--spacing-2); font-size: 0.75rem; }
        .context-pill-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .context-pill-remove { background: none; border: none; color: var(--text-tertiary); cursor: pointer; }
        
        .chat-input-container { display: flex; align-items: center; gap: var(--spacing-2); }
        .chat-input-wrapper { flex: 1; position: relative; }
        .chat-input { width: 100%; padding: var(--spacing-3) var(--spacing-4); background: var(--surface-elevated); border: 1px solid var(--input-border); border-radius: var(--radius-full); }
        .chat-send-btn { background: var(--btn-active-color); color: var(--bg-color); border: none; border-radius: var(--radius-full); width: 40px; height: 40px; display:flex; align-items:center; justify-content:center; cursor:pointer; }

        .tab-suggestions { display: none; position: absolute; bottom: calc(100% + var(--spacing-1)); left: 0; right: 0; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto; z-index: 101; }
        .suggestion-item { padding: var(--spacing-2) var(--spacing-3); cursor: pointer; }
        .suggestion-item:hover { background: var(--surface-hover); }
        .suggestion-title { font-weight: 500; }
        .suggestion-url { font-size: 0.8rem; color: var(--text-tertiary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-wrapper" id="mainWrapper">
            <div class="logo">AI Browser</div>
            <div class="mode-toggle" id="modeToggle">
                <button id="modeSearch" class="mode-btn active">Search</button>
                <button id="modeAsk" class="mode-btn">Ask</button>
            </div>

            <!-- Search Mode UI -->
            <div id="searchWrapper">
                <form id="searchForm" autocomplete="off">
                    <input id="searchInput" type="text" placeholder="Search or enter website" autofocus />
                </form>
            </div>

            <!-- Ask Mode UI (hidden by default) -->
            <div id="askWrapper" style="display:none;">
                <div class="chat-history" id="chatHistory" aria-live="polite"></div>
                <div class="chat-input-area">
                    <div id="contextPillsContainer" class="context-pills-container"></div>
                    <form class="chat-input-container" id="chatInputForm">
                        <div class="chat-input-wrapper">
                            <input id="chatInput" class="chat-input" type="text" placeholder="Ask a question..." />
                            <div id="tabSuggestions" class="tab-suggestions"></div>
                        </div>
                        <button type="submit" class="chat-send-btn" id="chatSendBtn" aria-label="Send message">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        class NewTabManager {
            constructor() {
                this.elements = {
                    modeSearch: document.getElementById('modeSearch'),
                    modeAsk: document.getElementById('modeAsk'),
                    searchWrapper: document.getElementById('searchWrapper'),
                    askWrapper: document.getElementById('askWrapper'),
                    searchInput: document.getElementById('searchInput'),
                    searchForm: document.getElementById('searchForm'),
                };
                this.mode = 'search';
                this.askManager = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.elements.modeSearch.addEventListener('click', () => this.switchMode('search'));
                this.elements.modeAsk.addEventListener('click', () => this.switchMode('ask'));
                this.elements.searchForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSearch();
                });
            }

            switchMode(newMode) {
                if (this.mode === newMode) return;
                this.mode = newMode;

                const isSearch = newMode === 'search';
                this.elements.modeSearch.classList.toggle('active', isSearch);
                this.elements.modeAsk.classList.toggle('active', !isSearch);
                this.elements.searchWrapper.style.display = isSearch ? 'block' : 'none';
                this.elements.askWrapper.style.display = isSearch ? 'none' : 'flex';

                if (isSearch) {
                    this.elements.searchInput.focus();
                } else {
                    if (!this.askManager) {
                        this.askManager = new AskManager();
                    }
                    this.askManager.elements.chatInput.focus();
                }
            }

            handleSearch() {
                const value = this.elements.searchInput.value.trim();
                if (!value) return;
                let target = value;
                if (!/^https?:\/\//i.test(value)) {
                    target = value.includes('.') && !value.includes(' ')
                        ? 'https://' + value
                        : 'https://www.google.com/search?q=' + encodeURIComponent(value);
                }
                window.location.href = target;
            }
        }

        class AskManager {
            constructor() {
                this.elements = {
                    chatHistory: document.getElementById('chatHistory'),
                    contextPillsContainer: document.getElementById('contextPillsContainer'),
                    chatInputForm: document.getElementById('chatInputForm'),
                    chatInput: document.getElementById('chatInput'),
                    tabSuggestions: document.getElementById('tabSuggestions'),
                };
                this.session = [];
                this.referencedTabs = new Set();
                this.allTabs = [];
                this.currentStream = null;
                this.marked = window.marked;
                this.setupEventListeners();
            }

            setupEventListeners() {
                this.elements.chatInputForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleChatSend();
                });
                this.elements.chatInput.addEventListener('input', () => this.handleChatInput());
                this.elements.tabSuggestions.addEventListener('click', (e) => this.handleSuggestionClick(e));
                window.addEventListener('message', (e) => this.handleHostMessage(e));
            }
            
            handleHostMessage({ data }) {
                if (!data || !data.type) return;
                switch (data.type) {
                    case 'tabs-response':
                        this.allTabs = data.tabs || [];
                        this.renderTabSuggestions(this.elements.chatInput.value);
                        break;
                    case 'chat-stream-response':
                        this.handleStreamResponse(data);
                        break;
                }
            }

            handleChatSend() {
                const content = this.elements.chatInput.value.trim();
                if (!content) return;
                this.elements.chatInput.value = '';

                this.session.push({ role: 'user', content });
                const assistantMsg = { role: 'assistant', content: '' };
                this.session.push(assistantMsg);
                this.renderChatHistory();

                const reqId = Date.now().toString();
                this.currentStream = { id: reqId, assistantIndex: this.session.length - 1 };

                const chatData = {
                    type: 'new-tab-chat-send',
                    reqId,
                    session: this.session.slice(0, -1),
                    referencedTabIds: [...this.referencedTabs]
                };
                console.log('NewTab: Sending new-tab-chat-send:', chatData);
                window.postMessage(
                    chatData,
                    '*'
                );
            }

            handleStreamResponse(data) {
                if (!this.currentStream || data.id !== this.currentStream.id) return;
                
                const assistantMsg = this.session[this.currentStream.assistantIndex];
                if (data.token) {
                    assistantMsg.content += data.token;
                    this.updateAssistantMessage(assistantMsg.content, false);
                }
                if (data.done || data.error) {
                    if(data.error) assistantMsg.content = `Error: ${data.error}`;
                    this.updateAssistantMessage(assistantMsg.content, true);
                    this.currentStream = null;
                }
            }
            
            updateAssistantMessage(content, isFinal) {
                const msgEls = this.elements.chatHistory.querySelectorAll('.assistant-msg');
                const lastMsgEl = msgEls[msgEls.length - 1];
                if (lastMsgEl) {
                    const contentEl = lastMsgEl.querySelector('.chat-content');
                    contentEl.innerHTML = isFinal ? this.marked.parse(content) : content.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
                    this.elements.chatHistory.scrollTop = this.elements.chatHistory.scrollHeight;
                }
            }

            renderChatHistory() {
                this.elements.chatHistory.innerHTML = this.session.map(msg => `
                    <div class="chat-msg ${msg.role}-msg">
                        <div class="chat-label">${msg.role === 'user' ? 'You' : 'AI'}</div>
                        <div class="chat-content">${this.marked.parse(msg.content || '')}</div>
                    </div>
                `).join('');
                this.elements.chatHistory.scrollTop = this.elements.chatHistory.scrollHeight;
            }

            handleChatInput() {
                const value = this.elements.chatInput.value;
                const atIndex = value.lastIndexOf('@');
                if (atIndex > -1 && (atIndex === 0 || /\s/.test(value[atIndex - 1]))) {
                    console.log('NewTab: Sending request-tabs');
                    window.postMessage({ type: 'request-tabs' }, '*');
                    this.renderTabSuggestions(value);
                } else {
                    this.hideTabSuggestions();
                }
            }

            renderTabSuggestions(value) {
                const query = value.substring(value.lastIndexOf('@') + 1).toLowerCase();
                const availableTabs = this.allTabs.filter(t => !this.referencedTabs.has(t.id));
                const filtered = query
                    ? availableTabs.filter(t => t.title.toLowerCase().includes(query) || t.url.toLowerCase().includes(query))
                    : availableTabs;

                if (filtered.length > 0) {
                    this.elements.tabSuggestions.innerHTML = filtered.map(tab => `
                        <div class="suggestion-item" data-tab-id="${tab.id}" data-tab-title="${this.escapeHtml(tab.title)}">
                            <div class="suggestion-title">${this.escapeHtml(tab.title)}</div>
                            <div class="suggestion-url">${this.escapeHtml(tab.url)}</div>
                        </div>`).join('');
                    this.elements.tabSuggestions.style.display = 'block';
                } else {
                    this.hideTabSuggestions();
                }
            }
            
            handleSuggestionClick(e) {
                const item = e.target.closest('.suggestion-item');
                if (!item) return;

                const tabId = item.getAttribute('data-tab-id');
                const tabTitle = item.getAttribute('data-tab-title');
                this.referencedTabs.add(tabId);
                this.renderContextPills();
                
                const atIndex = this.elements.chatInput.value.lastIndexOf('@');
                this.elements.chatInput.value = this.elements.chatInput.value.substring(0, atIndex);
                this.hideTabSuggestions();
                this.elements.chatInput.focus();
            }

            renderContextPills() {
                this.elements.contextPillsContainer.innerHTML = '';
                this.referencedTabs.forEach(tabId => {
                    const tab = this.allTabs.find(t => t.id === tabId);
                    const pill = document.createElement('div');
                    pill.className = 'context-pill';
                    pill.innerHTML = `
                        <span class="context-pill-title" title="${this.escapeHtml(tab ? tab.title : tabId)}">${this.escapeHtml(tab ? tab.title : tabId)}</span>
                        <button class="context-pill-remove" data-tab-id="${tabId}">&times;</button>`;
                    pill.querySelector('.context-pill-remove').addEventListener('click', () => {
                        this.referencedTabs.delete(tabId);
                        this.renderContextPills();
                    });
                    this.elements.contextPillsContainer.appendChild(pill);
                });
            }

            hideTabSuggestions() { this.elements.tabSuggestions.style.display = 'none'; }
            escapeHtml(str) { return str.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m])); }
        }

        document.addEventListener('DOMContentLoaded', () => new NewTabManager());
    </script>
</body>
</html> 